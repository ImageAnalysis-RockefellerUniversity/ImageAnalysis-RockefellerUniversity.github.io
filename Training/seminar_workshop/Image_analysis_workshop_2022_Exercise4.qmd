---
title: Exercise 4 - 3D segmentation using TrackMate (StarDist)
---

::: {layout-nrow=1 layout-ncol=3}
![Spheroid, Z-stack](images/Spheroid-3D_0.7X.gif)

![Z-stack segmentation](images/Spheroid-3D_LblImg_0.7X.gif)

![3D rendering](images/Spheroid-3D_LblImg_movie_0.7X.gif)
:::

3D stack of cells in a spheroid from [Zenodo](https://doi.org/10.5281/zenodo.5220610).

[Download TIF file](seminar_workkshop/images/Spheroid-3D_8bit.tif)    
  
- Open above Z-stack in Fiji and run the `TrackMate` plugin, just like in [Exercise 2](Image_analysis_workshop_2022_Exercise2.qmd).
- Since this is a Z-stack and TrackMate works on a time-lapse sequence, we need to swap Z and T dimensions. TrackMate automatically detects it and asks for dimension swapping. Click `Yes`.   
  
  ![](PNGs/Swap_Z_T_message.png)
- For the detector, choose `StarDist detector` from the drop-down menu.  
- For the tracker, choose `Simple LAP tracker` and the following tracking settings:  
  `Linking max distance=5 pixel` (a lower value than in Exercise 2, since the cells are not moving)  
  `Gap-closing max distance=10 pixel`  
  `Gap-closing max frame gap=0` (since cells are not disappearing from frame-to-frame)  
- Keep clicking the next button until you reach the `Display options` window (image below). Choose:  
  `Color spots by: Track index`  
  Uncheck `Display tracks`    
  
  ![](PNGs/display_options.png)
  
  Every cell will be outlined in a different color. Scroll through the stack to check the accuracy of the results. If results are not optimum, go back to the detection and/or tracker steps by clicking on the previous button (green left arrow) and changing the settings under detector and tracker.  
  
- On the last TrackMate window called `Select an action`, generate a label image by selecting `Export label image` from the drop-down list and clicking `Execute`. It will generate a grayscale Z-stack.    
- Apply colors to cells with an LUT: `Image › Lookup Tables › glasbey_inverted`  
- For creating a 3D rendering, swap Z and T dimensions back to the original values by selecting `Image › Properties...` and entering `Z=64` and `T=1`. Click OK. 
- Generate 3D rendering by using 3D viewer plugin: `Plugins › 3D Viewer`.
  Select `Resampling factor = 1`.  
  If a window pops up asking to convert the Z-stack to 8-bit or RGB image, click `Yes`.  
  In the ImageJ 3D Viewer window, use left mouse click and drag to rotate and inspect the volume.  

  
Well done, if you finished all 4 exercises!  

